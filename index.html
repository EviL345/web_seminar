<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç≥ –ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Arial',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}.container{max-width:1200px;margin:0 auto;padding:20px}.header{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:20px;padding:30px;text-align:center;margin-bottom:30px;border:1px solid rgba(255,255,255,0.2)}.header h1{color:white;font-size:2.5em;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}.nav-tabs{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin:20px 0}.tab-btn{background:rgba(255,255,255,0.2);border:none;color:white;padding:12px 24px;border-radius:25px;cursor:pointer;transition:all 0.3s ease;font-size:16px;backdrop-filter:blur(10px)}.tab-btn:hover,.tab-btn.active{background:rgba(255,255,255,0.3);transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}.tab-content{display:none;background:rgba(255,255,255,0.95);border-radius:20px;padding:30px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.3)}.tab-content.active{display:block;animation:fadeIn 0.5s ease-in-out}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}.card{background:white;border-radius:15px;padding:20px;box-shadow:0 8px 25px rgba(0,0,0,0.1);transition:all 0.3s ease;border:1px solid rgba(0,0,0,0.05)}.card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,0.15)}.card h3{color:#333;margin-bottom:10px;font-size:1.4em}.card p{color:#666;margin-bottom:10px;line-height:1.6}.chef-info{background:linear-gradient(45deg,#f093fb 0%,#f5576c 100%);color:white;padding:10px;border-radius:10px;margin:10px 0}.ingredients{background:#f8f9fa;padding:15px;border-radius:10px;margin:10px 0}.ingredients h4{margin-bottom:10px;color:#495057}.ingredient-tag{display:inline-block;background:linear-gradient(45deg,#667eea,#764ba2);color:white;padding:5px 12px;border-radius:20px;margin:3px;font-size:12px}.btn{background:linear-gradient(45deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:25px;cursor:pointer;transition:all 0.3s ease;font-size:14px;margin:5px}.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}.btn-success{background:linear-gradient(45deg,#56ab2f,#a8e6cf)}.btn-danger{background:linear-gradient(45deg,#ff6b6b,#ffa07a)}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#495057}.form-control{width:100%;padding:12px;border:2px solid #e9ecef;border-radius:10px;font-size:16px;transition:border-color 0.3s ease}.form-control:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}.search-container{margin-bottom:20px}.search-box{display:flex;gap:10px;align-items:center}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}.stat-card{background:linear-gradient(45deg,#667eea,#764ba2);color:white;padding:20px;border-radius:15px;text-align:center}.stat-number{font-size:2em;font-weight:bold;margin-bottom:5px}.price{font-size:1.2em;font-weight:bold;color:#28a745}.rating{color:#ffc107;font-size:1.1em}.video-link{background:#ff4757;color:white;text-decoration:none;padding:8px 16px;border-radius:20px;display:inline-block;margin-top:10px;transition:all 0.3s ease}.video-link:hover{background:#ff3742;transform:scale(1.05)}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);backdrop-filter:blur(5px)}.modal-content{background-color:white;margin:5% auto;padding:30px;border-radius:20px;width:90%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}.close:hover{color:#000}.loading{text-align:center;padding:40px;color:#666}.spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 2s linear infinite;margin:0 auto 20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.alert{padding:15px;margin-bottom:20px;border-radius:10px;border:1px solid transparent}.alert-success{background-color:#d4edda;border-color:#c3e6cb;color:#155724}.alert-danger{background-color:#f8d7da;border-color:#f5c6cb;color:#721c24}.chat-container{position:fixed;bottom:20px;right:20px;width:350px;z-index:1000}.chat-toggle{background:linear-gradient(45deg,#667eea,#764ba2);color:white;border:none;padding:15px 20px;border-radius:50px;cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;margin-left:auto;transition:all 0.3s ease}.chat-toggle:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.3)}.chat-box{background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden;display:none;height:500px;flex-direction:column}.chat-box.active{display:flex}.chat-header{background:linear-gradient(45deg,#667eea,#764ba2);color:white;padding:15px;font-weight:bold;display:flex;justify-content:space-between;align-items:center}.chat-close{background:none;border:none;color:white;font-size:20px;cursor:pointer}.chat-messages{flex:1;padding:15px;overflow-y:auto;background:#f9f9f9}.message{margin-bottom:15px;max-width:80%;padding:10px 15px;border-radius:15px;word-wrap:break-word}.user-message{background:#e3f2fd;margin-left:auto;border-bottom-right-radius:5px}.bot-message{background:#f1f1f1;margin-right:auto;border-bottom-left-radius:5px}.chat-input-container{padding:15px;background:white;border-top:1px solid #eee;display:flex}.chat-input{flex:1;padding:10px 15px;border:1px solid #ddd;border-radius:25px;outline:none}.chat-send{background:linear-gradient(45deg,#667eea,#764ba2);color:white;border:none;padding:10px 15px;border-radius:25px;margin-left:10px;cursor:pointer;transition:all 0.3s ease}.chat-send:hover{transform:translateY(-2px)}.typing-indicator{display:flex;padding:10px 15px;background:#f1f1f1;border-radius:15px;margin-bottom:15px;width:fit-content;border-bottom-left-radius:5px}.typing-dot{width:8px;height:8px;background:#666;border-radius:50%;margin:0 2px;animation:typingAnimation 1.4s infinite ease-in-out}.typing-dot:nth-child(1){animation-delay:0s}.typing-dot:nth-child(2){animation-delay:0.2s}.typing-dot:nth-child(3){animation-delay:0.4s}@keyframes typingAnimation{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}@media (max-width:768px){.nav-tabs{flex-direction:column;align-items:center}.grid{grid-template-columns:1fr}.search-box{flex-direction:column}.chat-container{width:90%;right:5%;bottom:10px}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç≥ –ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1>
            <p style="color: rgba(255,255,255,0.8); font-size: 1.1em;">–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã –æ—Ç –ª—É—á—à–∏—Ö –ø–æ–≤–∞—Ä–æ–≤ –º–∏—Ä–∞</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('recipes')">üìö –†–µ—Ü–µ–ø—Ç—ã</button>
            <button class="tab-btn" onclick="showTab('chefs')">üë®‚Äçüç≥ –ü–æ–≤–∞—Ä–∞</button>
            <button class="tab-btn" onclick="showTab('masterclasses')">üéì –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</button>
            <button class="tab-btn" onclick="showTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="tab-btn" onclick="showTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </div>

        <div id="recipes" class="tab-content active">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" class="form-control" placeholder=" üîç –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤...">
                    <button class="btn" onclick="searchRecipes()">–ù–∞–π—Ç–∏</button>
                    <button class="btn btn-success" onclick="showAddRecipeModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</button>
                </div>
            </div>
            <div id="recipesContent" class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤...</p>
            </div>
        </div>

        <div id="chefs" class="tab-content">
            <div id="chefsContent" class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≤–∞—Ä–æ–≤...</p>
            </div>
        </div>

        <div id="masterclasses" class="tab-content">
            <div id="masterclassesContent" class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤...</p>
            </div>
        </div>

        <div id="users" class="tab-content">
            <button class="btn btn-success" onclick="showAddUserModal()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            <div id="usersContent" class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
            </div>
        </div>

        <div id="stats" class="tab-content">
            <div id="statsContent" class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <button class="chat-toggle" onclick="toggleChat()">üí¨ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</button>
        <div class="chat-box" id="chatBox">
            <div class="chat-header">
                <span>–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</span>
                <button class="chat-close" onclick="toggleChat()">√ó</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleChatKeyPress(event)">
                <button class="chat-send" onclick="sendMessageToBot()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="addRecipeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addRecipeModal')">&times;</span>
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç</h2>
            <form id="addRecipeForm">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <input type="text" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea name="description" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                    <textarea name="ingredients" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>ID –ø–æ–≤–∞—Ä–∞:</label>
                    <input type="number" name="chef_id" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ:</label>
                    <input type="url" name="video_url" class="form-control">
                </div>
                <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                    <input type="text" name="preferences" class="form-control" placeholder="–∏—Ç–∞–ª—å—è–Ω—Å–∫–∞—è,—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è">
                </div>
                <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </form>
        </div>
    </div>

    <div id="shoppingListModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('shoppingListModal')">&times;</span>
            <h2>üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h2>
            <div id="shoppingListContent"></div>
        </div>
    </div>

    <div id="recommendationsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('recommendationsModal')">&times;</span>
            <h2>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å</h2>
            <div id="recommendationsContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        const TELEGRAM_BOT_TOKEN = '8046958792:AAG49rsIgG2rMiQTLStIZCUUbMimVNcK4cY';
        const TELEGRAM_CHAT_ID = '-1002545627162';
        const DEEPSEEK_API_KEY = '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';
        let isTelegramMode = false;

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            loadTabData(tabName);
        }

        async function loadTabData(tabName) {
            try {
                const response = await fetch(`${API_BASE}/${tabName}`);
                const data = await response.json();
                displayData(tabName, data);
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${tabName}:`, error);
                document.getElementById(`${tabName}Content`).innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
            }
        }

        function displayData(tabName, data) {
            const content = document.getElementById(`${tabName}Content`);
            if (!data || data.length === 0) {
                content.innerHTML = '<p>–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            content.innerHTML = `<div class="grid">${data.map(item => generateCard(tabName, item)).join('')}</div>`;
        }

        function generateCard(tabName, item) {
            switch(tabName) {
                case 'recipes':
                    return `<div class="card">
                        <h3>${item.title}</h3><p>${item.description}</p>
                        <div class="chef-info"><strong>üë®‚Äçüç≥ –ü–æ–≤–∞—Ä:</strong> ${item.chef_name}</div>
                        <div class="ingredients"><h4>ü•ò –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</h4>
                        ${item.ingredients.map(ing => `<span class="ingredient-tag">${ing}</span>`).join('')}</div>
                        <div style="margin-top:15px;">
                            ${item.video_url ? `<a href="${item.video_url}" target="_blank" class="video-link">üé• –°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ</a>` : ''}
                            <button class="btn" onclick="generateShoppingList(${item.id})">üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</button>
                        </div>
                        <small style="color:#999;">üìÖ ${new Date(item.created_at).toLocaleDateString('ru-RU')}</small>
                    </div>`;
                case 'chefs':
                    return `<div class="card">
                        <h3>${item.name}</h3><div class="rating">‚≠ê ${item.rating}/5.0</div>
                        <p><strong>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</strong> ${item.speciality}</p><p>${item.description}</p>
                        <div style="margin-top:15px;">
                            <button class="btn" onclick="subscribeToChef(${item.id})">üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                            <button class="btn btn-success" onclick="getRecommendations(1)">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
                        </div>
                    </div>`;
                case 'masterclasses':
                    return `<div class="card">
                        <h3>${item.title}</h3>
                        <div class="chef-info"><strong>üë®‚Äçüç≥ –ü–æ–≤–∞—Ä:</strong> ${item.chef_name}</div>
                        <p>${item.description}</p>
                        <p><strong>üìÖ –î–∞—Ç–∞:</strong> ${new Date(item.datetime).toLocaleString('ru-RU')}</p>
                        <p><strong>‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${item.duration} –º–∏–Ω—É—Ç</p>
                        <p><strong>üë• –ú–∞–∫—Å–∏–º—É–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</strong> ${item.max_students}</p>
                        <div class="price">üí∞ ${item.price} ‚ÇΩ</div>
                        <div style="margin-top:15px;">
                            <button class="btn btn-success" onclick="enrollInClass(${item.id})">üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
                        </div>
                    </div>`;
                case 'users':
                    return `<div class="card">
                        <h3>üë§ ${item.username}</h3>
                        <p><strong>üìß Email:</strong> ${item.email}</p>
                        <p><strong>‚ù§Ô∏è –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è:</strong> ${item.preferences || '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}</p>
                        <div style="margin-top:15px;">
                            <button class="btn" onclick="getUserHistory(${item.id})">üìã –ò—Å—Ç–æ—Ä–∏—è</button>
                            <button class="btn btn-success" onclick="getRecommendations(${item.id})">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
                        </div>
                    </div>`;
                case 'stats':
                    return `<div class="stat-card">
                        <div class="stat-number">${item.total_recipes}</div>
                        <div>üìö –†–µ—Ü–µ–ø—Ç–æ–≤</div>
                    </div>`;
                default:
                    return '';
            }
        }

        async function searchRecipes() {
            const query = document.getElementById('searchInput').value;
            if (!query.trim()) return loadTabData('recipes');
            try {
                const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}`);
                displayData('recipes', await response.json());
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤', 'danger');
            }
        }

        async function generateShoppingList(recipeId) {
            try {
                const response = await fetch(`${API_BASE}/shopping-list?recipe_id=${recipeId}`);
                const data = await response.json();
                document.getElementById('shoppingListContent').innerHTML = `
                    <h3>üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h3>
                    <ul style="list-style:none;padding:0;">
                        ${data.shopping_list.map(item => `<li style="padding:8px;border-bottom:1px solid #eee;">‚úì ${item}</li>`).join('')}
                    </ul>`;
                document.getElementById('shoppingListModal').style.display = 'block';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫:', error);
                showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫', 'danger');
            }
        }

        async function getRecommendations(userId) {
            try {
                const response = await fetch(`${API_BASE}/recommendations?user_id=${userId}`);
                const recommendations = await response.json();
                document.getElementById('recommendationsContent').innerHTML = recommendations.length ? 
                    `<div class="grid">${recommendations.map(mc => generateCard('masterclasses', mc)).join('')}</div>` : 
                    '<p>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                document.getElementById('recommendationsModal').style.display = 'block';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π', 'danger');
            }
        }

        async function subscribeToChef(chefId) {
            try {
                const response = await fetch(`${API_BASE}/subscribe`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: 1, chef_id: chefId})
                });
                showAlert(response.ok ? '–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –ø–æ–≤–∞—Ä–∞!' : '–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏', response.ok ? 'success' : 'danger');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏', 'danger');
            }
        }

        async function enrollInClass(masterClassId) {
            if (!confirm('–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ—Ç –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å?')) return;
            try {
                const response = await fetch(`${API_BASE}/enroll`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: 1, master_class_id: masterClassId})
                });
                showAlert(response.ok ? '–£—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å!' : '–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏', response.ok ? 'success' : 'danger');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å', 'danger');
            }
        }

        async function getUserHistory(userId) {
            try {
                const response = await fetch(`${API_BASE}/user-history?user_id=${userId}`);
                const history = await response.json();
                showCustomModal('–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π', history.length ? 
                    `<div style="max-height:300px;overflow-y:auto;">
                        ${history.map(entry => `<div class="card" style="margin-bottom:10px;">
                            <h4>${entry.class_title}</h4>
                            <p><strong>üë®‚Äçüç≥ –ü–æ–≤–∞—Ä:</strong> ${entry.chef_name}</p>
                            <p><strong>üìÖ –î–∞—Ç–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è:</strong> ${new Date(entry.attended_at).toLocaleString('ru-RU')}</p>
                        </div>`).join('')}
                    </div>` : '<p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏', 'danger');
            }
        }

        function showAddRecipeModal() {
            document.getElementById('addRecipeModal').style.display = 'block';
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showCustomModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `<div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>${title}</h2>${content}</div>`;
            document.body.appendChild(modal);
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        function toggleChat() {
            document.getElementById('chatBox').classList.toggle('active');
        }

        function handleChatKeyPress(e) {
            if (e.key === 'Enter') sendMessageToBot();
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const existingIndicator = document.getElementById('typingIndicator');
            if (existingIndicator) existingIndicator.remove();
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
            messagesContainer.appendChild(indicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function addMessageToChat(message, className) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${className}`;
            messageElement.textContent = message;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendToTelegram(message) {
            try {
                await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: `üç≥ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ:\n\n${message}`,
                        parse_mode: 'HTML'
                    })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram:', error);
            }
        }

        const OPENROUTER_API_KEY = "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";
const OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions";

async function getAIResponse(message) {
    try {
        const response = await fetch(OPENROUTER_API_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json',
                'HTTP-Referer': window.location.href,
                'X-Title': 'Culinary Assistant'
            },
            body: JSON.stringify({
                model: "deepseek/deepseek-chat:free",
                messages: [
                    {
                        role: "system",
                        content: "You are a helpful culinary assistant. Respond in Russian."
                    },
                    {
                        role: "user",
                        content: message
                    }
                ],
                temperature: 0.7,
                max_tokens: 1000
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('OpenRouter API Error:', errorData);
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();
        return data.choices?.[0]?.message?.content || "–ù–µ –º–æ–≥—É —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.";

    } catch (error) {
        console.error('API Request Failed:', error);
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    }
}

        async function sendMessageToBot() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addMessageToChat(message, 'user-message');
            input.value = '';
            showTypingIndicator();
            
            try {
                const [aiResponse] = await Promise.allSettled([
                    getAIResponse(message),
                    sendToTelegram(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${message}`)
                ]);
                
                hideTypingIndicator();
                
                if (aiResponse.status === 'fulfilled') {
                    addMessageToChat(aiResponse.value, 'bot-message');
                    await sendToTelegram(`–û—Ç–≤–µ—Ç –±–æ—Ç–∞: ${aiResponse.value}`);
                } else {
                    addMessageToChat('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ. üòî', 'bot-message');
                }
            } catch (error) {
                console.error('–û–±—â–∞—è –æ—à–∏–±–∫–∞ –≤ sendMessage:', error);
                hideTypingIndicator();
                addMessageToChat('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É. üîÑ', 'bot-message');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const addRecipeForm = document.getElementById('addRecipeForm');
            if (addRecipeForm) {
                addRecipeForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const recipeData = {
                        title: formData.get('title'),
                        description: formData.get('description'),
                        ingredients: formData.get('ingredients').split(',').map(s => s.trim()),
                        chef_id: parseInt(formData.get('chef_id')),
                        video_url: formData.get('video_url')
                    };
                    try {
                        const response = await fetch(`${API_BASE}/recipes`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(recipeData)
                        });
                        if (response.ok) {
                            showAlert('–†–µ—Ü–µ–ø—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                            closeModal('addRecipeModal');
                            this.reset();
                            loadTabData('recipes');
                        } else {
                            showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞', 'danger');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞', 'danger');
                    }
                });
            }

            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const userData = {
                        username: formData.get('username'),
                        email: formData.get('email'),
                        preferences: formData.get('preferences')
                    };
                    try {
                        const response = await fetch(`${API_BASE}/users`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(userData)
                        });
                        if (response.ok) {
                            showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                            closeModal('addUserModal');
                            this.reset();
                            loadTabData('users');
                        } else {
                            showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'danger');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'danger');
                    }
                });
            }

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') searchRecipes();
                });
            }

            window.addEventListener('click', function(event) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (event.target === modal) modal.style.display = 'none';
                });
            });

            loadTabData('recipes');
        });
    </script>
</body>
</html>